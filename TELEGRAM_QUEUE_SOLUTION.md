# –†–µ—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–∫–∏ 429 Too Many Requests

## üìã –ü—Ä–æ–±–ª–µ–º–∞

Telegram API –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—à–∏–±–∫—É **429 Too Many Requests** –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤.

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **–æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤** (`TelegramRequestQueue`) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∫ Telegram API —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.

### üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

1. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
2. **–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏** - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (150ms –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
3. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤** - HIGH, NORMAL, LOW
4. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
5. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ** - –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# Telegram API Request Queue Configuration
TELEGRAM_QUEUE_ENABLED=true                      # –í–∫–ª—é—á–∏—Ç—å –æ—á–µ—Ä–µ–¥—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: true)
TELEGRAM_MAX_CONCURRENT_REQUESTS=5               # –ú–∞–∫—Å. –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5)
TELEGRAM_REQUEST_DELAY_MS=150                    # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 150ms)
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

#### –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è 429 –æ—à–∏–±–æ–∫:
```env
TELEGRAM_QUEUE_ENABLED=true
TELEGRAM_MAX_CONCURRENT_REQUESTS=3               # –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ
TELEGRAM_REQUEST_DELAY_MS=200                    # 200ms = 5 req/s
```

#### –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ 429 –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç):
```env
TELEGRAM_QUEUE_ENABLED=true
TELEGRAM_MAX_CONCURRENT_REQUESTS=10
TELEGRAM_REQUEST_DELAY_MS=100                    # 100ms = 10 req/s
```

#### –î–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ (–µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–∞):
```env
TELEGRAM_QUEUE_ENABLED=false
```

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **TelegramRequestQueue** (`app/services/telegram_queue.py`)
   - –£–ø—Ä–∞–≤–ª—è–µ—Ç –æ—á–µ—Ä–µ–¥—å—é –∑–∞–ø—Ä–æ—Å–æ–≤
   - –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º —á–µ—Ä–µ–∑ `asyncio.Semaphore`
   - –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ TelegramService**
   - –ú–µ—Ç–æ–¥ `_execute_with_queue()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—ë—Ä—Ç–∫–∞
   - –ú–µ—Ç–æ–¥—ã `get_file_info()` –∏ `download_file()` –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ—á–µ—Ä–µ–¥—å

3. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (`app/config.py`)
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Ä–∞–±–æ—Ç—É

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
–ó–∞–ø—Ä–æ—Å ‚Üí –û—á–µ—Ä–µ–¥—å ‚Üí –°–µ–º–∞—Ñ–æ—Ä (–ª–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞) ‚Üí –ó–∞–¥–µ—Ä–∂–∫–∞ ‚Üí –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
         ‚Üì
    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```

1. –ó–∞–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
2. Worker –∑–∞–±–∏—Ä–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∏–∑ –æ—á–µ—Ä–µ–¥–∏
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–µ–º–∞—Ñ–æ—Ä (–ª–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞)
4. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
5. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å
6. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏

–î–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ —ç–Ω–¥–ø–æ–∏–Ω—Ç `/api/stats`:

```json
{
  "request_queue": {
    "queued_requests": 100,
    "completed_requests": 95,
    "failed_requests": 5,
    "avg_wait_time_ms": 45.2,
    "avg_execution_time_ms": 120.5,
    "queue_size": 5,
    "available_slots": 2
  }
}
```

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ

–û—á–µ—Ä–µ–¥—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏. –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Telegram API –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞).

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ (–±—É–¥—É—â–∞—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞)

```python
# –°–µ–π—á–∞—Å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º NORMAL
# –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
await telegram_service.get_file_info(file_id, priority=RequestPriority.HIGH)
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –æ—á–µ—Ä–µ–¥–∏

1. –í–∫–ª—é—á–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
```env
TELEGRAM_API_DETAILED_LOGGING=true
```

2. –°–¥–µ–ª–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤:
```bash
curl http://localhost:8081/stickers/{file_id}
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ—Ä—è–¥–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

```bash
curl http://localhost:8081/api/stats
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É `request_queue`.

## üéõÔ∏è –†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –ü–æ–¥–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

1. **–ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ 429 –æ—à–∏–±–∫–∏:**
   - –£–º–µ–Ω—å—à–∏—Ç–µ `TELEGRAM_MAX_CONCURRENT_REQUESTS` –¥–æ 3
   - –£–≤–µ–ª–∏—á—å—Ç–µ `TELEGRAM_REQUEST_DELAY_MS` –¥–æ 200-300

2. **–ï—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–æ:**
   - –£–≤–µ–ª–∏—á—å—Ç–µ `TELEGRAM_MAX_CONCURRENT_REQUESTS` –¥–æ 10
   - –£–º–µ–Ω—å—à–∏—Ç–µ `TELEGRAM_REQUEST_DELAY_MS` –¥–æ 100

3. **–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:**
   - –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: `max_concurrent=3`, `delay=200ms`
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ: `max_concurrent=5`, `delay=150ms` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ (`TELEGRAM_API_DETAILED_LOGGING=true`) –≤–∏–¥–Ω–æ:

```
Queued request: _get_with_retry, queue_size=3
Executing request: _get_with_retry, wait_time=45.2ms
Request completed: _get_with_retry, wait_time=45.2ms, execution_time=120.5ms
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û—á–µ—Ä–µ–¥—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** - –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–µ–Ω—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
2. **–ö—ç—à –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç** - –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –∫—ç—à–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å
3. **–¢–æ–ª—å–∫–æ API –∑–∞–ø—Ä–æ—Å—ã** - –æ—á–µ—Ä–µ–¥—å –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã –∫ Telegram API
4. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ `/api/stats`

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–†–µ—à–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env` (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è 429 –æ—à–∏–±–æ–∫

