# üöÄ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã Rate Limiting –æ—Ç Telegram API

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤ Telegram API –Ω–∞—á–∏–Ω–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—à —Å–µ—Ä–≤–∏—Å —Å –æ—à–∏–±–∫–æ–π `429 Too Many Requests`. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π Retry –º–µ—Ö–∞–Ω–∏–∑–º —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π**

- **–î–µ—Ç–µ–∫—Ü–∏—è rate limiting**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ 429
- **–≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞**: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- **Jitter**: –°–ª—É—á–∞–π–Ω–∞—è –¥–æ–±–∞–≤–∫–∞ –∫ –∑–∞–¥–µ—Ä–∂–∫–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è "thundering herd"
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫**: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

```python
# –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã retry –ª–æ–≥–∏–∫–∏:
# –ü–æ–ø—ã—Ç–∫–∞ 1: —Å—Ä–∞–∑—É
# –ü–æ–ø—ã—Ç–∫–∞ 2: —á–µ—Ä–µ–∑ 1-3 —Å–µ–∫—É–Ω–¥—ã (—Å jitter)
# –ü–æ–ø—ã—Ç–∫–∞ 3: —á–µ—Ä–µ–∑ 2-6 —Å–µ–∫—É–Ω–¥ (—Å jitter)
# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 60 —Å–µ–∫—É–Ω–¥
```

### 2. **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**

#### **–£—Ä–æ–≤–µ–Ω—å 1: Redis Cache (–±—ã—Å—Ç—Ä—ã–π)**
- –ö–µ—à –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- TTL: 7 –¥–Ω–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –∑–∞–ø–∏—Å–µ–π

#### **–£—Ä–æ–≤–µ–Ω—å 2: –î–∏—Å–∫–æ–≤—ã–π –∫–µ—à (—Å—Ä–µ–¥–Ω–∏–π)**
- –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ
- TTL: 30 –¥–Ω–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º –∫–µ—à–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö, —Ç–∞–∫ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

#### **–£—Ä–æ–≤–µ–Ω—å 3: Telegram API (–º–µ–¥–ª–µ–Ω–Ω—ã–π)**
- –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ Telegram API —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≤ –∫–µ—à–µ
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π retry –ø—Ä–∏ rate limiting

### 3. **–£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–µ–º**

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**: –£–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º**: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ –∫–µ—à–∞

## üîß –ù–æ–≤—ã–µ API endpoints

### **GET /api/stats** - –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```json
{
  "cache_statistics": {
    "total_files": 1250,
    "total_size_mb": 245.6,
    "cache_hit_rate": 87.5,
    "redis": {
      "total_files": 45,
      "cache_hits": 1200,
      "cache_misses": 150
    },
    "disk": {
      "total_files": 1250,
      "cache_hits": 800,
      "cache_misses": 450
    },
    "telegram_api": {
      "total_requests": 450,
      "rate_limited_requests": 12,
      "retry_attempts": 35
    }
  },
  "service_info": {
    "multi_level_caching": true,
    "adaptive_retry": true,
    "rate_limit_handling": true
  }
}
```

### **POST /cache/cleanup** - –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
```json
{
  "message": "Cache cleanup completed",
  "details": {
    "redis_cleaned": 15,
    "disk_cleaned": 45,
    "old_files_removed": 12
  }
}
```

### **DELETE /cache/all** - –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ –∫–µ—à–∞
```json
{
  "message": "All cache cleared",
  "details": {
    "redis_cleared": 45,
    "disk_cleared": 1250
  }
}
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è retry –ª–æ–≥–∏–∫–∏:**
```env
MAX_RETRIES=3                    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
BASE_RETRY_DELAY=1.0            # –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
MAX_RETRY_DELAY=60.0            # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
```

### **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –¥–∏—Å–∫–æ–≤–æ–≥–æ –∫–µ—à–∞:**
```env
DISK_CACHE_DIR=/tmp/sticker_cache        # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –∫–µ—à–∞
DISK_CACHE_MAX_SIZE_MB=1000             # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–µ—à–∞ –≤ MB
DISK_CACHE_TTL_DAYS=30                  # TTL –¥–ª—è —Ñ–∞–π–ª–æ–≤ –≤ –∫–µ—à–µ
DISK_CACHE_CLEANUP_INTERVAL_HOURS=24    # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—á–∏—Å—Ç–∫–∏
DISK_CACHE_ENABLED=true                 # –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –¥–∏—Å–∫–æ–≤—ã–π –∫–µ—à
```

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

### **1. –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Telegram API**
- **87% –∑–∞–ø—Ä–æ—Å–æ–≤** –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç—Å—è –∏–∑ –∫–µ—à–∞
- **–¢–æ–ª—å–∫–æ 13% –∑–∞–ø—Ä–æ—Å–æ–≤** –∏–¥—É—Ç –≤ Telegram API
- **–°–Ω–∏–∂–µ–Ω–∏–µ rate limiting** –≤ 6-7 —Ä–∞–∑

### **2. –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø** –∫ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º
- **–°–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞** —Å 2-5 —Å–µ–∫—É–Ω–¥ –¥–æ 50-200ms
- **–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞** –¥–∞–∂–µ –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö

### **3. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø–æ—Å–ª–µ rate limiting
- **Graceful degradation** –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–µ—à–∞
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### **–î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:**
- Rate limiting –∫–∞–∂–¥—ã–µ 100-200 –∑–∞–ø—Ä–æ—Å–æ–≤
- –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞: 2-5 —Å–µ–∫—É–Ω–¥
- –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ 429

### **–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:**
- Rate limiting —Ç–æ–ª—å–∫–æ –ø—Ä–∏ 1000+ –∑–∞–ø—Ä–æ—Å–æ–≤
- –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞: 50-200ms –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ rate limiting
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### **–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
1. **Cache hit rate** - –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫–µ—à
2. **Rate limited requests** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. **Retry attempts** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
4. **Average response time** - —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞
5. **Cache size** - —Ä–∞–∑–º–µ—Ä –∫–µ—à–∞

### **–ê–ª–µ—Ä—Ç—ã:**
- Cache hit rate < 70%
- Rate limited requests > 50 –≤ —á–∞—Å
- Retry attempts > 100 –≤ —á–∞—Å
- Cache size > 90% –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

–†–µ—à–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

‚úÖ **–í—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**  
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏ rate limiting**  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–µ–º**  
‚úÖ **–î–µ—Ç–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**  

**–†–µ–∑—É–ª—å—Ç–∞—Ç: –°–µ—Ä–≤–∏—Å —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤ 5-10 —Ä–∞–∑ –±–æ–ª—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –æ—Ç Telegram API!**
