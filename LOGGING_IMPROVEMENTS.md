# üìù Telegram API Logging Improvements

## –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–î–æ–±–∞–≤–ª–µ–Ω–æ **–ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –≤—Å–µ—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å Telegram Bot API.

---

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞**
```python
# –î–æ
logger.error(f"Error getting file info for {file_id}: {e}")

# –ü–æ—Å–ª–µ  
api_logger.error(
    f"[getFile-AgADA2QA] ‚úó Telegram API Error - "
    f"code=400, description=Bad Request: file_id is not valid, "
    f"file_id=AgADA2QA, time=120ms"
)
```

**–¢–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π request ID
- ‚úÖ –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–º—Å)
- ‚úÖ HTTP —Å—Ç–∞—Ç—É—Å—ã –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏
- ‚úÖ –†–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ –ö–æ–¥—ã –æ—à–∏–±–æ–∫ —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
- ‚úÖ –¢–∏–ø –æ—à–∏–±–∫–∏ (timeout, client error, API error)

### 2. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ API –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**
```bash
curl http://localhost:8081/api/stats
```

**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- –£—Å–ø–µ—à–Ω—ã–µ/–Ω–µ—É–¥–∞—á–Ω—ã–µ
- Success rate (%)
- –°–∫–∞—á–∞–Ω–æ –¥–∞–Ω–Ω—ã—Ö (MB)
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
- –û—à–∏–±–∫–∏ –ø–æ —Ç–∏–ø–∞–º

### 3. **–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ**
```log
================================================================================
Telegram API Statistics Summary:
  Total Requests: 1543
  Successful: 1489 (96.5%)
  Failed: 54
  Total Downloaded: 245.67 MB
  Average Response Time: 187.3ms
  Errors by Type:
    HTTP_404_NOT_FOUND: 32
    TIMEOUT: 15
================================================================================
```

### 4. **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫**
- `HTTP_404_NOT_FOUND` - —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
- `HTTP_403_FORBIDDEN` - –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
- `API_ERROR_400` - –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π file_id
- `TIMEOUT` - –ø—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç
- `CLIENT_ERROR_*` - —Å–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- `FILE_TOO_LARGE` - –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞

---

## üîß –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Core Changes
- ‚úÖ `app/config.py` - –¥–æ–±–∞–≤–ª–µ–Ω `telegram_api_detailed_logging`
- ‚úÖ `app/services/telegram.py` - –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ `app/main.py` - –Ω–æ–≤—ã–π endpoint `/api/stats`

### Configuration
- ‚úÖ `config.env.example` - –¥–æ–±–∞–≤–ª–µ–Ω `TELEGRAM_API_DETAILED_LOGGING`
- ‚úÖ `docker-compose.yml` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∞ –≤ `RATE_LIMIT_WINDOW_SEC`

### Documentation
- ‚úÖ `TELEGRAM_API_LOGGING.md` - –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- ‚úÖ `LOGGING_QUICK_START.md` - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- ‚úÖ `LOGGING_IMPROVEMENTS.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª
- ‚úÖ `README.md` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã endpoints –∏ monitoring

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### 1. –í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í `.env`:
```bash
TELEGRAM_API_DETAILED_LOGGING=true
```

### 2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

```bash
# –í—Å–µ API –∑–∞–ø—Ä–æ—Å—ã
docker logs -f <container> 2>&1 | grep -E "Telegram API|‚úì|‚úó"

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
docker logs -f <container> 2>&1 | grep "‚úó"

# –¢–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ
docker logs -f <container> 2>&1 | grep "‚úì"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

```bash
curl http://localhost:8081/api/stats
```

---

## üìä –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

### –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```log
INFO - [getFile-AgADA2QA] Telegram API Request: getFile
DEBUG - [getFile-AgADA2QA] Response Status: 200
INFO - [getFile-AgADA2QA] ‚úì getFile SUCCESS - path=stickers/file.webp, size=12456 bytes, time=145ms
```

### –û—à–∏–±–∫–∞
```log
ERROR - [download-file.webp] ‚úó FILE NOT FOUND (404) - file_path=stickers/file.webp, time=234ms
ERROR - File not found on Telegram servers: stickers/file.webp
```

### –¢–∞–π–º–∞—É—Ç
```log
ERROR - [download-file.webp] ‚úó TIMEOUT - timeout=30s, elapsed=30150ms
ERROR - Timeout downloading file stickers/file.webp after 30150ms
```

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ù–∞–π—Ç–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```bash
docker logs <container> 2>&1 | grep "time=" | grep -E "time=[0-9]{4,}ms"
```

### –ù–∞–π—Ç–∏ –≤—Å–µ 404 –æ—à–∏–±–∫–∏
```bash
docker logs <container> 2>&1 | grep "404"
```

### –ù–∞–π—Ç–∏ —Ç–∞–π–º–∞—É—Ç—ã
```bash
docker logs <container> 2>&1 | grep "TIMEOUT"
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å breakdown –æ—à–∏–±–æ–∫
```bash
curl http://localhost:8081/api/stats | jq '.telegram_api_statistics.errors_by_type'
```

---

## ‚öôÔ∏è –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

### Development (–≤—Å–µ –¥–µ—Ç–∞–ª–∏)
```bash
LOG_LEVEL=DEBUG
TELEGRAM_API_DETAILED_LOGGING=true
```
–õ–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å –ø–æ–ª–Ω—ã–º–∏ –¥–µ—Ç–∞–ª—è–º–∏.

### Production (—É–º–µ—Ä–µ–Ω–Ω–æ)
```bash
LOG_LEVEL=INFO
TELEGRAM_API_DETAILED_LOGGING=true
```
–õ–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—Ö–∏ –∫—Ä–∞—Ç–∫–æ, –æ—à–∏–±–∫–∏ –ø–æ–¥—Ä–æ–±–Ω–æ.

### Production (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
```bash
LOG_LEVEL=INFO
TELEGRAM_API_DETAILED_LOGGING=false
```
–õ–æ–≥–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ –∏ –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.

---

## üí° –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?

### –î–æ —É–ª—É—á—à–µ–Ω–∏–π:
```log
ERROR - Error downloading file stickers/file_0.webp: Unknown error
```
‚ùå –ù–µ –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ
‚ùå –ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å

### –ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:
```log
ERROR - [download-file_0.webp] ‚úó FILE NOT FOUND (404) - 
        file_path=stickers/file_0.webp, time=234ms
ERROR - File not found on Telegram servers: stickers/file_0.webp
```
‚úÖ –ü–æ–Ω—è—Ç–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ (404)
‚úÖ –ï—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø—É—Ç—å –∫ —Ñ–∞–π–ª—É, –≤—Ä–µ–º—è)
‚úÖ –ú–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ request_id

---

## üìà –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
```bash
# –ü–æ request ID
docker logs <container> 2>&1 | grep "getFile-AgADA2QA"
```

### 2. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```bash
# –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
docker logs <container> 2>&1 | grep "speed=" | 
  awk -F'speed=' '{print $2}' | awk '{print $1}' |
  awk '{s+=$1; c++} END {print s/c " MB/s"}'
```

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤
```bash
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å—ã
docker logs <container> 2>&1 | 
  grep -E "Telegram API|‚úì|‚úó" > telegram_api_logs.txt
```

---

## üéØ –¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ß–∞—Å—Ç—ã–µ 404 –æ—à–∏–±–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
```bash
curl http://localhost:8081/api/stats
# "HTTP_404_NOT_FOUND": 50
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
docker logs <container> 2>&1 | grep "404"
```

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ file_id –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
**–ü—Ä–æ–±–ª–µ–º–∞**: –ó–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è > 1s
```bash
curl http://localhost:8081/api/stats
# "average_response_time_ms": 1500
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
docker logs <container> 2>&1 | grep "time=" | 
  sort -t'=' -k2 -n | tail -10
```

**–†–µ—à–µ–Ω–∏–µ**: 
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- –£–≤–µ–ª–∏—á–∏—Ç—å `TELEGRAM_TIMEOUT_SEC`
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ß–∞—Å—Ç—ã–µ —Ç–∞–π–º–∞—É—Ç—ã
**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–Ω–æ–≥–æ TIMEOUT –æ—à–∏–±–æ–∫
```bash
curl http://localhost:8081/api/stats
# "TIMEOUT": 25
```

**–†–µ—à–µ–Ω–∏–µ**: –í `.env` —É–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç
```bash
TELEGRAM_TIMEOUT_SEC=60
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **`TELEGRAM_API_LOGGING.md`** - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—é
- **`LOGGING_QUICK_START.md`** - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- **`README.md`** - –û–±–Ω–æ–≤–ª–µ–Ω —Å –Ω–æ–≤—ã–º–∏ endpoints

---

## ‚ú® –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. ‚úÖ **–ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** - –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
2. ‚úÖ **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** - –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞, —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
3. ‚úÖ **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ** - request_id –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
4. ‚úÖ **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - success rate, breakdown –æ—à–∏–±–æ–∫
5. ‚úÖ **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏
6. ‚úÖ **Production-ready** - –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ prod

---

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–ü—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `TELEGRAM_API_DETAILED_LOGGING=true` –≤ `.env` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å.

–õ–æ–≥–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞—Ç—å –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º! üìù‚ú®

